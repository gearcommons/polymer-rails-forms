<link rel="import" href="rails-form-helpers.html" >
<link rel="import" href="rails-form-validators.html" >
<link rel="import" href="gc-paper-decorator.html" >
<link rel="import" href="form-spinner.html" >
<link rel="import" href="../paper-button/paper-button.html" >
<link rel="import" href="../core-icons/image-icons.html" >
<link rel="import" href="../core-ajax/core-xhr.html" >

<script src='pikaday.js'></script>

<polymer-element name="rails-form">
  <template>
    <link rel='stylesheet' href='pikaday.css'> 
    <style>
      :host {
        display: block;
      }
      paper-button {
        font-size: 14px;
      }

      paper-button core-icon {
        margin-right: 5px;
        color: #5bc0de;
      }
      
      #submit-button {
        margin-top: 15px;
        margin-bottom: 5px;
        padding-left: 30px;
        padding-right: 30px;
        background-color: #5bc0de;
        border-color: #46b8da;
        color: white;
        clear: both;
        margin-right: 15px;
      }

      #submit-button.in-transit span{
        display: none;
      }

      #submit-button.in-transit form-spinner {
        display: block;
      }

      #submit-button form-spinner {
        display: none;
      }

      gc-input-decorator {
        text-align: left !important;
      }

      gc-input-decorator .label {
        text-align: left !important;
      }

      .btn-image-upload {
        position: relative;
        overflow: hidden;
        width: 100%;
        height: 59px;
        display: table;
      }

      .btn-image-upload core-icon {
        height: 105px;
        width: 105px;
        margin: 0 auto;
        display: block;
        color: #666;
      }

      .btn-image-upload input[type=file] {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        font-size: 999px;
        text-align: right;
        filter: alpha(opacity=0);
        opacity: 0;
        outline: none;
        background: white;
        cursor: inherit;
        display: block;
      }

      .list-group {
        width: 100%;
        box-sizing: border-box;
        display: block;
        padding: 9px 0px 0px 10px;
        font-size: 14px;
      }

      .list-group .list-item {
        width: 100%;
      }

      .list-group .list-item .list-item-display {
        border-bottom: solid 1px;
        display: flex;
        flex-direction: row;
      }

      .list-group .list-item .list-item-display div {
        flex: 1;
        cursor: pointer;
      }

      .list-wrapper {
        overflow: auto;
        font-size: 0px; 
        padding-top: 10px;
        min-height: 55px;
      }

      .list-wrapper paper-button {
        max-width: 28%;
        margin: 0px;
      }

      .list-wrapper paper-button /deep/ .button-content{
        -webkit-justify-content: flex-start !important;
        justify-content: flex-start !important;
      }

      .list-wrapper .list {
        overflow: auto;
        position: relative;
        float: right;
        box-sizing: border-box;
        width: 72%;
        max-height: 81px;
      }

      .list-wrapper h4 {
        padding: 10px 15px;
        float: left;
        box-sizing: border-box;
        width: 25%;
        margin: 0;
        font-weight: 500;
        font-size: 14px;
      }

      .list-group .list-item {
        display: block;
        list-style-type: none;
        margin: 0;
        padding: 0 15px;
        box-sizing: border-box;
      }

      .list-group .list-item core-icon {
        height: 0px;
        border: solid 1px #A1A1A1;
        padding: 7px;
        width: 0px;
        border-radius: 8px;
        color: red;
        margin-right: 10px;
      }

      .list-group .list-form {
        display: none;
      }

      .list-group.focused .list-item, .list-group.is-invalid .list-item, .list-group.is-blank .list-item {
        display: none;
      }

      .list-group.focused .list-form, .list-group.is-invalid .list-form, .list-group.is-blank .list-form {
        display: block;
        overflow: hidden;
      }

      paper-checkbox input[type=checkbox] {
        display: none;
      }

      .select-wrapper {
        position: relative;
      }

      .select-wrapper .pseudo-select {
        opacity: 0;
        display: none;
        transition: opacity 250ms ease-out;
        position: absolute;
        top: 100%;
        width: 106%;
        background-color: white;
        box-shadow: -2px 1px 10px #888;
        margin-top: -11px;
        z-index: 1;
        margin-left: -3%;
      }

      .select-wrapper.opened .pseudo-select {
        opacity: 1;
        display: block;
      }

      .select-wrapper input.pseudo-select-input {
        padding-right: 20px;
        box-sizing: border-box;
      }

      .select-wrapper .select-icon {
        position: absolute;
        right: -6px;
        width: 35px;
        bottom: -6px;
        height: 35px;
      }

      .select-wrapper .pseudo-select > div {
        min-height: 2em;
        border-bottom: solid 1px;
        padding: 5px 3%;
        position: relative;
      } 

      .select-wrapper .pseudo-select > div:hover {
        background-color: #D5DAFF;
      }

      .select-wrapper .pseudo-select > div paper-checkbox {
        float: left;
        margin-right: 15px;
      }

    </style>
    <!-- TODO: structures should be arrays to preserve order -->
    <form id="rails_form" _action="{{ action }}" method="{{ method }}" enctype="multipart/form-data">
      <template bind="{{ data as data }}">
        <template bind="{{ structure as structure }}" bind="{{ scope as scope }}" id="form-group">
          <template repeat="{{ key in structure | getKeys }}">
            <div class='{{ structure[key] | wrapperClass }} {{ key }} {{ structure[key] | isHidden }}'>
              <template if="{{ structure[key] | isNest }}">
                <template if="{{ structure[key].allowAdd }}">
                  <paper-button class='{{ key | scopeToClass }}' on-click="{{ addItem }}"><core-icon icon="add-circle-outline"></core-icon>{{ structure[key].label }}</paper-button>
                </template>
                <template if="{{ structure[key] | isMultiple }}">
                  <template if="{{ !structure[key].allowAdd }}">
                    <template repeat="{{ item in data | scopeNestData(key) | enumerate }}">
                      <template ref="form-group" bind="{{ structure[key].structure as structure }}" parentContext="{{ key | updateParentContext }}" scope="{{ scope | updateScope(key) | addIndex(item) }}" data="{{ data | scopeDataToIndex(item) }}"></template>
                    </template>
                  </template>

                  <template if='{{ structure[key].allowAdd }}'>
                    <template bind="{{ data as data }}">
                      <div class='list'>
                        <template repeat="{{ item in data | scopeNestData(key) | enumerate }}">
                          <div class='list-group {{ item | isEmpty }}'>
                            <div class='list-item {{ item | listItemClassName }}'>
                              {{ item | createListItem }}
                            </div>
                            <div class='list-form {{ item | listItemClassName }}'>
                              <template ref="form-group" bind="{{ structure[key].structure as structure }}" parentContext="{{ key | updateParentContext }}" scope="{{ scope | updateScope(key) | addIndex(item) }}" data="{{ data | scopeDataToIndex(item) }}"></template>
                            </div>
                          </div>
                        </template>
                      </div>
                    </template>
                  </template>
                </template>

                <template if="{{ structure[key] | isNotMultiple }}">
                  <template bind="{{ context as context }}">
                    <template ref="form-group" bind="{{ structure[key].structure as structure }}" parentContext="{{ key | updateParentContext }}" scope="{{ scope | updateScope(key) }}" data="{{ data | scopeNestData(key) }}"></template>
                  </template>
                </template>
              </template>
              
              <template if="{{ structure[key] | isField }}">
                <template bind="{{ data as data }}">
                  <div class="input {{ key | scopeToClass }}" scope="{{ data | scopeFieldData(key) }}">
                    {{ structure[key] | createInput }}
                  </div>
                </template>
              </template>
            </div>
          </template>
        </template>
      </template>
      <div class='sumbit-button-wrapper'>
        <paper-button id='submit-button' raised>
          <span class='submit-text'>{{ submitText }}</span>
          <form-spinner height="1.5" width="1.5"></form-spinner>
        </paper-button>
        <!-- <paper-button id='test-button' raised>Test</paper-button> -->
        <template if="{{ xhr }}">
          <core-xhr id='xhr'></core-xhr>
        </template>
      </div>
    </form>
  </template>
  <script>
    /*
      Default Structure Item: {
        type: "string",
        label: "",
        options: {
          floatingLabel: true,
          unscoped: false,
          events: {}
        },
        attributes: {

        }
      }
    */

    Polymer( Polymer.mixin ({
      publish: {
        scope: "",
        action: "",
        method: "POST",
        structure: null,
        data: null,
        submitText: "Submit",
        xhr: false,
        unscopedData: null
      },

      parentContext: null,
      parentStructure: null,
      parentData: null,
      
      inTransit: false,

      toArray: function(str){
        return [str];
      },

      created: function(){
        this.structure = {};
        this.inputList = [];
        this.indexStore = {};
        
        var data = this.data === null ? {} : this.data;
        if (!!this.scope && this.scope.replace(/\s/g, "").length > 0){
          if (data[this.scope] === void(0)) data[this.scope] = {};
          this.data = data[this.scope];
        } else {
          this.data = data;
        }

        this.unscopedData = data;
        this.unscopedScope = this.scope;
      },

      handleXhrCallback: function(){
        
      },

      domReady: function(){
        var form = this.shadowRoot.querySelector("form"),
            button = this.shadowRoot.querySelector("#submit-button"),
            test = this.shadowRoot.querySelector("#test-button");

        var callback = function(resp){
          this.inTransit = false;
          this.handleXhrCallback(resp);
        }.bind(this)

        button.addEventListener("click", function(e){
          // console.log(this.action, this.unscopedData);
          // return;    
          if (this.inTransit) return;
          if (this.isFormInvalid()) return; 

          if (this.action !== null){
            if (this.xhr){
              this.inTransit = true;
          
              if (!!this.scope && this.scope.length > 0){
                var data = {};
                data[this.scope] = this.data;
              } else {
                data = this.data;
              }

              this.$.xhr.request({ 
                method: this.method, 
                url: this.action, 
                body: new FormData(form), 
                callback: callback
                //headers: { "Content-type": "application/json", "Accept": "application/json" }
              })
              
            } else {
              this.inTransit = true;
              form.submit();
            }
          }
        }.bind(this), false)

        this.appendInputs();
        var inputObserver = new ArrayObserver(this.inputList);
            inputObserver.open(function(splices){
              this.appendInputs();
            }.bind(this))

        form.addEventListener("change", function(e){
          var group = this.findParent(e.target, ".list-group")
          if (!!group){
            this.checkForBlank(group);
          }
        }.bind(this), true)

        var spinner = button.querySelector('form-spinner');
        new PathObserver(this, 'inTransit').open(function(){
          if (this.inTransit){
            spinner.start();
            this.addClass(button, 'in-transit');
          } else {
            spinner.stop();
            this.removeClass(button, 'in-transit');
          }
        }.bind(this));

      },

      get getData() {
        return this.data;
      }
    }, FormHelpers, Validation));
  </script>
</polymer-element>